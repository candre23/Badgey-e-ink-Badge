/*
  Heltec Vision Master E290 (HT-VME290) - E-Badge (Framebuffer over BLE + Serial)
  - Wake key: USER_KEY = GPIO21 (EXT0 wake on LOW)
  - User LED: GPIO45 blinks 500ms on/off while awake
  - On boot: show "E-Badge" centered
  - Display rotation: 180 degrees vs earlier GPIO test (setRotation(2))
  - Awake/connectable for 5 minutes OR until an update is received
  - Updates can come from:
      * BLE framebuffer characteristic (preferred)
      * BLE text characteristic (kept for debug/back-compat)
      * Serial newline text (debug)
  - After update: refresh e-ink, then deep sleep
*/

#include <Arduino.h>
#include "heltec-eink-modules.h"   // heltec-eink-modules (todd-herbert)
#include <NimBLEDevice.h>          // NimBLE-Arduino / esp-nimble-cpp wrapper

// --------- Pins ----------
static const gpio_num_t WAKE_BTN = GPIO_NUM_21; // USER_KEY verified as GPIO21
static const int USER_LED_PIN = 45;             // user LED per schematic
// -------------------------

static const uint32_t AWAKE_WINDOW_MS = 5UL * 60UL * 1000UL;

// Display size (Vision Master E290)
static const uint16_t BADGE_W = 128;
static const uint16_t BADGE_H = 296;
static const uint16_t FB_BYTES = (BADGE_W * BADGE_H) / 8; // 4736



// -------- Firmware / status --------
static const char* FW_VERSION = "0.1";

// -------- Battery sense (E290) --------
// VBAT_READ is GPIO7 (ADC1_CH6). Divider is 390k (top) / 100k (bottom) -> multiplier 4.9.
static const int   BAT_ADC_PIN = 7;

// Some Heltec designs gate the VBAT divider with ADC_Ctrl to reduce drain.
// If your readings are 0 or nonsense, set USE_ADC_CTRL true and set ADC_CTRL_PIN.
// If readings are fine without it, leave USE_ADC_CTRL false.
static const bool  USE_ADC_CTRL = true;   // try false first; flip to true if needed
static const int   ADC_CTRL_PIN = 46;      // best-guess; only used if USE_ADC_CTRL = true

// Divider multiplier: Vbat = Vadc * 4.9 (390k+100k)/100k
static const float BAT_MULT     = 4.9f;


static uint8_t lipoPercentFromVolts(float v) {
  // Rough LiPo OCV curve (single cell) at room temp.
  // Note: under load, voltage sags; after resting, it rebounds.
  // Clamp and then interpolate between points.

  if (v <= 3.30f) return 0;
  if (v >= 4.20f) return 100;

  struct Pt { float v; uint8_t p; };
  static const Pt curve[] = {
    {4.20f,100}, {4.15f, 95}, {4.11f, 90}, {4.08f, 85}, {4.02f, 75},
    {3.98f, 70}, {3.95f, 65}, {3.91f, 55}, {3.87f, 45}, {3.85f, 40},
    {3.84f, 35}, {3.82f, 30}, {3.80f, 25}, {3.79f, 20}, {3.77f, 15},
    {3.75f, 10}, {3.73f,  7}, {3.71f,  5}, {3.69f,  3}, {3.61f,  1},
    {3.50f,  0}, {3.30f,  0}
  };

  // Find the two points that bracket v, then linear-interpolate between their %
  for (size_t i = 0; i + 1 < sizeof(curve)/sizeof(curve[0]); i++) {
    if (v <= curve[i].v && v >= curve[i + 1].v) {
      float v1 = curve[i].v, v2 = curve[i + 1].v;
      float p1 = (float)curve[i].p, p2 = (float)curve[i + 1].p;

      float t = (v - v2) / (v1 - v2);  // 0..1
      float p = p2 + t * (p1 - p2);
      if (p < 0) p = 0;
      if (p > 100) p = 100;
      return (uint8_t)(p + 0.5f);
    }
  }

  // Fallback (shouldnâ€™t happen due to clamps)
  return 0;
}


// Double-tap timing
static const uint32_t DOUBLE_TAP_WINDOW_MS = 450;
static const uint32_t DEBOUNCE_MS          = 30;

// After last double-tap, keep device awake for 5 minutes then sleep
static const uint32_t INTERACT_WINDOW_MS   = 5UL * 60UL * 1000UL;

// -------- Retained display buffers (RTC memory) --------
RTC_DATA_ATTR static uint8_t  g_savedFb[FB_BYTES];
RTC_DATA_ATTR static bool     g_hasSavedFb = false;

enum UiMode : uint8_t { UI_STATUS = 0, UI_LIVE = 1, UI_SAVED = 2, UI_BOOT = 3 };
RTC_DATA_ATTR static UiMode   g_uiMode = UI_LIVE;



// BLE UUIDs
static const char* BLE_DEVICE_NAME = "E-Badge";
static const char* SERVICE_UUID    = "6a3a7b52-2d6d-4a2b-8d1a-0d4d6c3a1c10";
static const char* CHAR_TEXT_UUID  = "c2b6b0b5-0d18-4d9a-8f2c-6a3b90a0b8a1";
// New framebuffer characteristic UUID (matches Android app)
static const char* CHAR_FB_UUID    = "f3a7e19c-5f21-4c3c-8b64-3c2f6fd1c4ab";

EInkDisplay_VisionMasterE290 display;

static bool wokeFromButton() {
  return esp_sleep_get_wakeup_cause() == ESP_SLEEP_WAKEUP_EXT0;
}

// Serial line buffer
static String g_serialLine;

// Update flags/state
static volatile bool g_updateReady = false;
static bool g_haveFramebuffer = false;
static String g_latestText;

// Framebuffer RX state
static uint8_t g_fb[FB_BYTES];
static bool g_fbReceiving = false;
static uint16_t g_fbExpected = FB_BYTES;
static uint16_t g_fbOffset = 0;
static uint16_t g_fbLastProgress = 0;

// ---------- Boot logo (Badgey) ----------
// 1-bit, 120x149, MSB-first per byte (Adafruit_GFX drawBitmap format)
static const uint16_t LOGO_W = 128;
static const uint16_t LOGO_H = 296;

const unsigned char badgey_boot_logo[] PROGMEM = {
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x02, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x0f, 0xe0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x0f, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x19, 0xb0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x30, 0x98, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x30, 0xd8, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x60, 0x7c, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x60, 0x6c, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xc0, 0x3e, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xc0, 0x3e, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x80, 0x1f, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x80, 0x1f, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0x00, 0x1f, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x02, 0x00, 0x0f, 0xc0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x06, 0x00, 0x07, 0xc0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x06, 0x00, 0x07, 0xe0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x0c, 0x00, 0x07, 0xe0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x08, 0x00, 0x03, 0xf0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x18, 0x00, 0x03, 0xf0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x18, 0x00, 0x01, 0xf8, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x30, 0x00, 0x01, 0xf8, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x30, 0x00, 0x00, 0xf8, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x20, 0x00, 0x00, 0xfc, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x60, 0x00, 0x00, 0x7c, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x60, 0x00, 0x00, 0x7e, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xc0, 0x00, 0x00, 0x3e, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xc0, 0x00, 0x0f, 0xbf, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0x00, 0x11, 0x9f, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x9f, 0x00, 0x00, 0xdf, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0xb1, 0x80, 0x00, 0x4f, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0x60, 0x00, 0x00, 0x0f, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0x40, 0x00, 0x00, 0x0f, 0xc0, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x06, 0x00, 0x00, 0x00, 0x0f, 0xc0, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x06, 0x00, 0x00, 0x00, 0x07, 0xc0, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x06, 0x00, 0x00, 0x00, 0x07, 0xe0, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x0c, 0x00, 0x00, 0x00, 0x03, 0xe0, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x0c, 0x1c, 0x00, 0x00, 0x03, 0xe0, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x18, 0x23, 0x00, 0x0f, 0x83, 0xf0, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x18, 0xc1, 0x80, 0x30, 0x41, 0xf0, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x10, 0x00, 0x80, 0x20, 0x21, 0xf8, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x31, 0x00, 0x40, 0x40, 0x11, 0xf8, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x31, 0x18, 0x40, 0x00, 0x10, 0xf8, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x31, 0x3c, 0x60, 0x87, 0x10, 0xfc, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x61, 0x3c, 0x60, 0x87, 0x18, 0xfc, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x61, 0x3c, 0x00, 0x87, 0x18, 0x6c, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x61, 0x18, 0x40, 0x87, 0x10, 0x6e, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0xc1, 0x00, 0x40, 0x40, 0x10, 0x6e, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0xc0, 0x80, 0x80, 0x40, 0x10, 0x27, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0xc1, 0x00, 0x20, 0x20, 0x07, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x01, 0x80, 0x3e, 0x00, 0x10, 0x40, 0x27, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x01, 0x80, 0x00, 0x00, 0x0f, 0x9f, 0x93, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x60, 0x9b, 0x80, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x03, 0x00, 0x00, 0x00, 0x00, 0xc0, 0x43, 0x80, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x03, 0x00, 0x00, 0x00, 0x01, 0x80, 0x49, 0x80, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x03, 0x00, 0x00, 0x00, 0x03, 0x00, 0x48, 0xc0, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x06, 0x00, 0x00, 0x00, 0x04, 0x00, 0x41, 0xc0, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x06, 0x00, 0x00, 0x00, 0x18, 0x10, 0x84, 0xe0, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x06, 0x00, 0x00, 0x00, 0x30, 0x20, 0x86, 0x60, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x04, 0x00, 0x00, 0x00, 0xc0, 0xc1, 0x84, 0x60, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0xf8, 0x00, 0x0c, 0x00, 0x70, 0x9f, 0x01, 0x81, 0x04, 0x60, 0x00, 0x7f, 0xfc, 0x00, 
	0x00, 0x07, 0xff, 0x00, 0x0c, 0x01, 0xfe, 0xf8, 0x03, 0x03, 0x02, 0x70, 0x03, 0xf8, 0x0e, 0x00, 
	0x00, 0x1e, 0x07, 0xc0, 0x08, 0x03, 0xfe, 0x00, 0x04, 0x06, 0x02, 0x70, 0x1f, 0x00, 0x03, 0x00, 
	0x00, 0x38, 0x00, 0xf0, 0x18, 0x03, 0xff, 0x00, 0x10, 0x0c, 0x00, 0x70, 0xf8, 0x00, 0x01, 0x80, 
	0x00, 0xe0, 0x00, 0x1c, 0x18, 0x03, 0xff, 0x80, 0x60, 0x18, 0x01, 0xb3, 0xc0, 0x00, 0x00, 0xc0, 
	0x00, 0xc0, 0x00, 0x0f, 0x18, 0x03, 0xff, 0xef, 0x00, 0x30, 0x01, 0xff, 0x00, 0xff, 0x80, 0xc0, 
	0x01, 0x81, 0xfe, 0x03, 0xf0, 0x03, 0xff, 0xf0, 0x00, 0x60, 0x01, 0xf8, 0x0f, 0xc1, 0xc0, 0x60, 
	0x03, 0x03, 0xef, 0xc0, 0xf0, 0x01, 0xff, 0xe0, 0x01, 0xc0, 0x03, 0xe0, 0x3e, 0x00, 0x70, 0x60, 
	0x03, 0x07, 0x01, 0xf0, 0x70, 0x01, 0xff, 0xc0, 0x03, 0x00, 0x00, 0xc0, 0xf0, 0x00, 0x18, 0x20, 
	0x06, 0x0c, 0x00, 0x38, 0x30, 0x00, 0x7f, 0xc0, 0x0c, 0x00, 0x0c, 0xc3, 0x80, 0x00, 0x18, 0x20, 
	0x1c, 0x18, 0x00, 0x0e, 0x60, 0x00, 0x3f, 0xc0, 0x38, 0x00, 0x18, 0xcf, 0x00, 0x00, 0x0c, 0x30, 
	0x3c, 0x30, 0x00, 0x07, 0xe0, 0x00, 0x0f, 0xc3, 0xe0, 0x00, 0x20, 0x7e, 0x00, 0x00, 0x0c, 0x18, 
	0x7c, 0x30, 0x00, 0x01, 0xe0, 0x00, 0x00, 0x7e, 0x00, 0x00, 0x40, 0x7e, 0x00, 0x00, 0x0e, 0x3c, 
	0x7c, 0x78, 0x00, 0x00, 0xc0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0x7e, 0x00, 0x00, 0x1e, 0x3c, 
	0xfc, 0xc8, 0x00, 0x00, 0xc0, 0x00, 0x00, 0x00, 0x00, 0x01, 0x80, 0x7e, 0x00, 0x00, 0x1e, 0x26, 
	0xff, 0xc8, 0x00, 0x00, 0xc0, 0x00, 0x00, 0x00, 0x00, 0x02, 0x00, 0x7e, 0x00, 0x00, 0x3f, 0xe6, 
	0x77, 0x88, 0x00, 0x00, 0xc0, 0x00, 0x00, 0x00, 0x00, 0x04, 0x00, 0x3f, 0x00, 0x00, 0x3f, 0x86, 
	0x70, 0x18, 0x00, 0x01, 0x80, 0x00, 0x00, 0x00, 0x00, 0x08, 0x00, 0x3f, 0x00, 0x00, 0xff, 0x06, 
	0x7c, 0x3c, 0x00, 0x01, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x3f, 0x00, 0x01, 0xff, 0x86, 
	0x7f, 0xf6, 0x00, 0x01, 0x80, 0x00, 0x00, 0x00, 0x00, 0x20, 0x00, 0x7f, 0x00, 0x03, 0xbf, 0x8c, 
	0xff, 0xf2, 0x00, 0x01, 0x80, 0x00, 0x00, 0x00, 0x00, 0x40, 0x00, 0x9f, 0x00, 0x03, 0xbf, 0xf8, 
	0xff, 0xf3, 0x00, 0x01, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x1f, 0x80, 0x03, 0xbf, 0xf0, 
	0xff, 0xf7, 0x00, 0x03, 0x00, 0x00, 0x00, 0x00, 0x01, 0x00, 0x02, 0x1f, 0x80, 0x03, 0xfd, 0xf0, 
	0xff, 0xf6, 0x00, 0x03, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x04, 0x1f, 0x80, 0x03, 0xfd, 0xb0, 
	0xff, 0xfc, 0x00, 0x03, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x08, 0x1f, 0x80, 0x03, 0xff, 0xf0, 
	0xff, 0xfc, 0x00, 0x03, 0x00, 0x00, 0x00, 0x00, 0x10, 0x00, 0x30, 0x0f, 0x80, 0x07, 0xff, 0xf0, 
	0xff, 0xf8, 0x00, 0x06, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x20, 0x0f, 0xc0, 0x07, 0xff, 0xf0, 
	0xff, 0xf8, 0x00, 0x06, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x40, 0x0f, 0xc0, 0x07, 0xff, 0xe0, 
	0x7f, 0xf8, 0x00, 0x06, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x80, 0x0f, 0xc0, 0x03, 0xff, 0xc0, 
	0x1f, 0xf8, 0x00, 0x04, 0x00, 0x00, 0x00, 0x04, 0x00, 0x01, 0x00, 0x07, 0xc0, 0x01, 0xe0, 0x00, 
	0x07, 0xf0, 0x00, 0x0c, 0x00, 0x00, 0x00, 0x00, 0x00, 0x02, 0x00, 0x07, 0xe0, 0x00, 0x00, 0x00, 
	0x03, 0xf0, 0x00, 0x0c, 0x00, 0x00, 0x00, 0x00, 0x00, 0x04, 0x00, 0x07, 0xe0, 0x00, 0x00, 0x00, 
	0x01, 0xe0, 0x00, 0x0c, 0x00, 0x00, 0x00, 0x20, 0x00, 0x0c, 0x00, 0x07, 0xe0, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x0c, 0x00, 0x00, 0x00, 0x00, 0x00, 0x18, 0x00, 0x03, 0xe0, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x08, 0x00, 0x00, 0x01, 0x00, 0x00, 0x20, 0x00, 0x03, 0xe0, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x08, 0x00, 0x00, 0x00, 0x00, 0x00, 0x40, 0x00, 0x03, 0xf0, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x18, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0x00, 0x03, 0xf0, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x18, 0x00, 0x00, 0x30, 0x00, 0x01, 0x00, 0x00, 0x03, 0xf0, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x18, 0x00, 0x00, 0x00, 0x00, 0x02, 0x00, 0x00, 0x11, 0xf0, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x38, 0x00, 0x00, 0x80, 0x00, 0x06, 0x00, 0x00, 0x01, 0xf0, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x30, 0x00, 0x02, 0x00, 0x00, 0x08, 0x00, 0x00, 0x01, 0xf8, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x30, 0x00, 0x08, 0x00, 0x00, 0x10, 0x00, 0x00, 0x01, 0xf8, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x30, 0x00, 0x00, 0x00, 0x00, 0x20, 0x00, 0x00, 0x01, 0xf8, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x30, 0x00, 0x00, 0x00, 0x00, 0x60, 0x00, 0x00, 0x00, 0xfc, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x30, 0x01, 0x00, 0x00, 0x00, 0xc0, 0x00, 0x00, 0x00, 0xfc, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x60, 0x04, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0xfc, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x60, 0x10, 0x00, 0x00, 0x03, 0x00, 0x80, 0x00, 0x00, 0xfc, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x60, 0x00, 0x00, 0x00, 0x02, 0x00, 0x00, 0x00, 0x00, 0xfc, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x60, 0x00, 0x00, 0x00, 0x0c, 0x00, 0x00, 0x00, 0x00, 0x7c, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x40, 0x00, 0x00, 0x00, 0x08, 0x00, 0x00, 0x00, 0x00, 0x7e, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x48, 0x00, 0x00, 0x00, 0x10, 0x00, 0x00, 0x00, 0x00, 0x7e, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0xc0, 0x00, 0x00, 0x00, 0x20, 0x00, 0x04, 0x00, 0x00, 0x7e, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0xc0, 0x00, 0x00, 0x00, 0x60, 0x00, 0x00, 0x00, 0x00, 0x3e, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0xc0, 0x00, 0x00, 0x00, 0xc0, 0x00, 0x00, 0x00, 0x00, 0x3e, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x80, 0x00, 0x00, 0x00, 0x80, 0x00, 0x00, 0x00, 0x00, 0x3e, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x01, 0x80, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x3f, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x01, 0x80, 0x00, 0x00, 0x02, 0x00, 0x00, 0x00, 0x00, 0x00, 0x3f, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x01, 0x80, 0x00, 0x00, 0x02, 0x00, 0x00, 0x00, 0x00, 0x00, 0x3f, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x0c, 0x00, 0x40, 0x00, 0x00, 0x00, 0x1f, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x01, 0x80, 0x00, 0x00, 0x18, 0x00, 0x00, 0x00, 0x00, 0x00, 0x1f, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x18, 0x00, 0x00, 0x00, 0x00, 0x00, 0x0f, 0x80, 0x00, 0x00, 
	0x00, 0x00, 0x03, 0x00, 0x00, 0x00, 0x20, 0x00, 0x06, 0x80, 0x00, 0x00, 0x1f, 0x80, 0x00, 0x00, 
	0x00, 0x00, 0x03, 0x00, 0x00, 0x00, 0x60, 0x00, 0x3f, 0xc0, 0x00, 0x00, 0x1f, 0x80, 0x00, 0x00, 
	0x00, 0x00, 0x03, 0x00, 0x00, 0x00, 0x80, 0x01, 0xff, 0xf8, 0x00, 0x00, 0x0f, 0x80, 0x00, 0x00, 
	0x00, 0x00, 0x02, 0x00, 0x00, 0x00, 0x80, 0x07, 0xff, 0xfe, 0x00, 0x00, 0x0f, 0x80, 0x00, 0x00, 
	0x00, 0x00, 0x02, 0x00, 0x00, 0x01, 0x00, 0x0f, 0xff, 0xff, 0x80, 0x00, 0x0f, 0x80, 0x00, 0x00, 
	0x00, 0x00, 0x02, 0x00, 0x00, 0x00, 0x00, 0x3f, 0xe0, 0x7f, 0xe0, 0x00, 0x0f, 0xc0, 0x00, 0x00, 
	0x00, 0x00, 0x06, 0x00, 0x00, 0x02, 0x00, 0xff, 0x00, 0x1f, 0xf8, 0x00, 0x07, 0xc0, 0x00, 0x00, 
	0x00, 0x00, 0x06, 0x00, 0x00, 0x00, 0x03, 0xf8, 0x00, 0x07, 0x7c, 0x00, 0x07, 0xc0, 0x00, 0x00, 
	0x00, 0x00, 0x06, 0x00, 0x00, 0x0c, 0x0f, 0xe0, 0x00, 0x03, 0x3f, 0x00, 0x07, 0xc0, 0x00, 0x00, 
	0x00, 0x00, 0x06, 0x00, 0x00, 0x10, 0x1f, 0x80, 0x00, 0x03, 0x0f, 0x80, 0x07, 0xe0, 0x00, 0x00, 
	0x00, 0x00, 0x04, 0x00, 0x00, 0x10, 0x7e, 0x00, 0x00, 0x03, 0x0f, 0xe0, 0x07, 0xe0, 0x00, 0x00, 
	0x00, 0x00, 0x04, 0x00, 0x00, 0x21, 0xf8, 0x00, 0x00, 0x01, 0x87, 0xf0, 0x03, 0xe0, 0x00, 0x00, 
	0x00, 0x00, 0x0c, 0x00, 0x00, 0x03, 0xf0, 0x00, 0x00, 0x01, 0x87, 0xf8, 0x03, 0xe0, 0x00, 0x00, 
	0x00, 0x00, 0x0c, 0x00, 0x00, 0x47, 0xf0, 0x00, 0x00, 0x01, 0x86, 0x7e, 0x03, 0xe0, 0x00, 0x00, 
	0x00, 0x00, 0x0c, 0x00, 0x00, 0x1f, 0x60, 0x00, 0x00, 0x01, 0x86, 0x3f, 0x03, 0xe0, 0x00, 0x00, 
	0x00, 0x00, 0x0c, 0x00, 0x00, 0x3e, 0x60, 0x00, 0x00, 0x00, 0x86, 0x1f, 0x81, 0xe0, 0x00, 0x00, 
	0x00, 0x00, 0x0c, 0x00, 0x00, 0xfc, 0x60, 0x00, 0x00, 0x00, 0xc2, 0x07, 0xc1, 0xf0, 0x00, 0x00, 
	0x00, 0x00, 0x18, 0x00, 0x03, 0xfc, 0x60, 0x00, 0x00, 0x00, 0xc2, 0x03, 0xf1, 0xf0, 0x00, 0x00, 
	0x00, 0x00, 0x18, 0x00, 0x03, 0x98, 0x60, 0x00, 0x00, 0x00, 0xc3, 0x00, 0xf9, 0xf0, 0x00, 0x00, 
	0x00, 0x00, 0x18, 0x00, 0x07, 0x18, 0x60, 0x00, 0x00, 0x00, 0xc3, 0x00, 0x7c, 0xf0, 0x00, 0x00, 
	0x00, 0x00, 0x18, 0x00, 0x1e, 0x18, 0x40, 0x00, 0x00, 0x00, 0x43, 0x00, 0x3f, 0xf0, 0x00, 0x00, 
	0x00, 0x00, 0x18, 0x00, 0x3c, 0x18, 0x40, 0x00, 0x00, 0x00, 0x63, 0x00, 0x0f, 0xf8, 0x00, 0x00, 
	0x00, 0x00, 0x18, 0x00, 0x70, 0x10, 0xc0, 0x00, 0x00, 0x00, 0x61, 0x00, 0x07, 0xf8, 0x00, 0x00, 
	0x00, 0x00, 0x18, 0x00, 0xe0, 0x30, 0xc0, 0x00, 0x00, 0x00, 0x61, 0x00, 0x01, 0xf8, 0x00, 0x00, 
	0x00, 0x00, 0x18, 0x01, 0xc0, 0x30, 0xc0, 0x00, 0x00, 0x00, 0x61, 0x00, 0x00, 0xf8, 0x00, 0x00, 
	0x00, 0x00, 0x30, 0x03, 0x80, 0x30, 0xc0, 0x00, 0x00, 0x00, 0x61, 0x00, 0x00, 0x70, 0x00, 0x00, 
	0x00, 0x00, 0x30, 0x07, 0x00, 0x30, 0xc0, 0x00, 0x00, 0x00, 0x21, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x30, 0x1c, 0x00, 0x30, 0xc0, 0x00, 0x00, 0x00, 0x21, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x30, 0x18, 0x00, 0x30, 0xc0, 0x00, 0x00, 0x00, 0x21, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x30, 0x70, 0x00, 0x30, 0xc0, 0x00, 0x00, 0x00, 0x21, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x30, 0xe0, 0x00, 0x30, 0x80, 0x00, 0x00, 0x00, 0x21, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x21, 0xc0, 0x00, 0x30, 0x80, 0x00, 0x00, 0x00, 0x21, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x23, 0x80, 0x00, 0x30, 0x80, 0x00, 0x00, 0x00, 0x21, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x26, 0x00, 0x00, 0x30, 0x80, 0x00, 0x00, 0x00, 0x21, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x2c, 0x00, 0x00, 0x30, 0x80, 0x00, 0x00, 0x00, 0x61, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x38, 0x00, 0x00, 0x30, 0x80, 0x00, 0x00, 0x00, 0x61, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x70, 0x00, 0x00, 0x30, 0x80, 0x00, 0x00, 0x00, 0x63, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x20, 0x00, 0x00, 0x30, 0x80, 0x00, 0x00, 0x00, 0x63, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x30, 0xc0, 0x00, 0x00, 0x00, 0x63, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x30, 0xc0, 0x00, 0x00, 0x00, 0x63, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x30, 0xc0, 0x00, 0x00, 0x00, 0xc3, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x10, 0xc0, 0x00, 0x00, 0x00, 0xc2, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x18, 0xc0, 0x00, 0x00, 0x00, 0xc2, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x18, 0xc0, 0x00, 0x00, 0x00, 0xc6, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x18, 0xc0, 0x00, 0x00, 0x00, 0x86, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x18, 0xc0, 0x00, 0x00, 0x00, 0x84, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x18, 0xc0, 0x00, 0x00, 0x01, 0x8c, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x38, 0x40, 0x00, 0x00, 0x03, 0x8c, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x7c, 0x70, 0x00, 0x00, 0x07, 0x8e, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x6f, 0xf0, 0x00, 0x00, 0x0c, 0xdf, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x63, 0xf8, 0x00, 0x00, 0x0c, 0x79, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x30, 0xf0, 0x00, 0x00, 0x06, 0x23, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x0e, 0x39, 0xf0, 0x00, 0x00, 0x07, 0x87, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x3f, 0xff, 0xf0, 0x00, 0x00, 0x07, 0xfe, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x71, 0xff, 0xf8, 0x00, 0x00, 0x0f, 0xff, 0xfc, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0xe0, 0xff, 0xf8, 0x00, 0x00, 0x0f, 0xff, 0xfe, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0xe1, 0xff, 0xf8, 0x00, 0x00, 0x1f, 0xff, 0xff, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x01, 0xf1, 0xff, 0xf8, 0x00, 0x00, 0x1f, 0xff, 0xcf, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x01, 0xff, 0xff, 0xfc, 0x00, 0x00, 0x1f, 0xff, 0xdf, 0x80, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x01, 0xff, 0xff, 0xfc, 0x00, 0x00, 0x1f, 0xff, 0xff, 0x80, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x01, 0xff, 0xff, 0xf8, 0x00, 0x00, 0x1f, 0xff, 0xff, 0x80, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x01, 0xff, 0xff, 0xf8, 0x00, 0x00, 0x0f, 0xff, 0xff, 0x80, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0xff, 0xff, 0xf0, 0x00, 0x00, 0x07, 0xff, 0xff, 0x80, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x7f, 0xff, 0x80, 0x00, 0x00, 0x03, 0xff, 0xff, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x3f, 0xf0, 0x00, 0x00, 0x00, 0x00, 0xff, 0xfe, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x0e, 0x00, 0x00, 0x00, 0x00, 0x00, 0x3f, 0xfe, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0xf0, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
};

// Draw logo centered on current rotation/coordinate system.
static void drawBootLogo() {
display.fillScreen(WHITE);
display.drawBitmap(0, 0, badgey_boot_logo, LOGO_W, LOGO_H, BLACK);
display.update();
}


static float readBatteryVolts() {
  if (BAT_ADC_PIN < 0) return -1.0f;

  if (USE_ADC_CTRL) {
    pinMode(ADC_CTRL_PIN, OUTPUT);
    digitalWrite(ADC_CTRL_PIN, HIGH);
    delay(2);
  }

  // ESP32-S3 ADC: use 11dB attenuation so higher voltages on the ADC pin are measurable
  analogSetPinAttenuation(BAT_ADC_PIN, ADC_11db);
  delay(2);

  // Average a few reads to reduce noise
  const int samples = 16;
  uint32_t accMv = 0;
  for (int i = 0; i < samples; i++) {
    accMv += (uint32_t)analogReadMilliVolts(BAT_ADC_PIN);
    delay(2);
  }
  float mv = (float)accMv / (float)samples;

  if (USE_ADC_CTRL) {
    digitalWrite(ADC_CTRL_PIN, LOW);
  }

  float v_adc  = mv / 1000.0f;
  float v_batt = v_adc * BAT_MULT;
  return v_batt;
}
static void drawSavedFramebuffer();

static void drawStatusScreen() {
  display.fillScreen(WHITE);
  display.setTextColor(BLACK);
  display.setTextSize(1);

  const float vb = readBatteryVolts();
	uint8_t pct = (vb < 0.0f) ? 0 : lipoPercentFromVolts(vb);

  display.setCursor(2, 8);
  display.print("E-Badge Status");

  display.setCursor(2, 28);
  display.print("FW: ");
  display.print(FW_VERSION);

  display.setCursor(2, 44);
  display.print("Uptime: ");
  display.print((uint32_t)(millis() / 1000));
  display.print("s");


	display.setCursor(2, 60);
display.print("Batt: ");
if (vb < 0.0f) {
  display.print("N/A");
} else {
  display.print(vb, 2);
  display.print(" V (");
  display.print(pct);
  display.print("%)");
}

  display.setCursor(2, 76);
  display.print("Saved FB: ");
  display.print(g_hasSavedFb ? "yes" : "no");

  display.setCursor(2, 92);
  display.print("Mode: ");
  display.print((int)g_uiMode);


  display.update();
}



// -------- Display helpers --------
static void drawCenteredText(const String& s, uint8_t textSize) {
  display.fillScreen(WHITE);
  display.setTextColor(BLACK);
  display.setTextSize(textSize);

  int16_t x1, y1;
  uint16_t w, h;
  display.getTextBounds(s, 0, 0, &x1, &y1, &w, &h);

  int16_t x = (display.width()  - (int16_t)w) / 2;
  int16_t y = (display.height() - (int16_t)h) / 2;
  if (x < 0) x = 0;
  if (y < 0) y = 0;

  display.setCursor(x, y);
  display.print(s);
  display.update();
}

static void drawFramebufferToDisplay(const uint8_t* packed, uint16_t w, uint16_t h) {
  display.fillScreen(WHITE);
  display.drawBitmap(0, 0, packed, w, h, BLACK);
  display.update();
}

static void drawSavedFramebuffer() {
  if (!g_hasSavedFb) {
    display.fillScreen(WHITE);
    display.setTextColor(BLACK);
    display.setTextSize(1);
    display.setCursor(2, 8);
    display.print("No saved framebuffer");
    display.setCursor(2, 28);
    display.print("Send an image first.");
    display.update();
    return;
  }

  // Draw the retained framebuffer (saved across deep sleep)
  drawFramebufferToDisplay(g_savedFb, BADGE_W, BADGE_H);
}

// -------- Power / sleep --------
static void goToDeepSleep() {
  Serial.println("[sleep] Turning off LED and entering deep sleep...");

  digitalWrite(USER_LED_PIN, LOW);
  pinMode(USER_LED_PIN, INPUT); // best-effort to reduce leakage

  esp_sleep_enable_ext0_wakeup(WAKE_BTN, 0); // wake on LOW
  delay(50);
  esp_deep_sleep_start();
}

// -------- BLE callbacks --------
class TextCallbacks : public NimBLECharacteristicCallbacks {
  void onWrite(NimBLECharacteristic* pCharacteristic, NimBLEConnInfo& connInfo) override {
    (void)connInfo;

    std::string v = pCharacteristic->getValue();
    if (v.empty()) return;

    if (v.size() > 200) v.resize(200);
    g_latestText = String(v.c_str());
    g_haveFramebuffer = false;
    g_updateReady = true;

    Serial.print("[ble:text] Received text: ");
    Serial.println(g_latestText);
  }
};

// Parse little-endian u16 from a byte pointer
static uint16_t u16le(const uint8_t* p) {
  return (uint16_t)p[0] | ((uint16_t)p[1] << 8);
}

class FramebufferCallbacks : public NimBLECharacteristicCallbacks {
  void onWrite(NimBLECharacteristic* pCharacteristic, NimBLEConnInfo& connInfo) override {
    (void)connInfo;

    const std::string v = pCharacteristic->getValue();
    if (v.empty()) return;

    const uint8_t* data = (const uint8_t*)v.data();
    size_t len = v.size();
    Serial.print("[ble:fb] onWrite len=");
    Serial.println((int)len);


    // Helper to consume bytes from this packet
    auto consume = [&](size_t n) {
      data += n;
      len  -= n;
    };


    // If we're not currently receiving, the packet should begin with a header.
    // But be tolerant: header+payload may come in same write.
    if (!g_fbReceiving) {
      // Accept either:
      //   A) "EBG1" + w(u16) + h(u16) + payloadLen(u16)  (10 bytes total)
      //   B) "FB"   + payloadLen(u16)                   (4 bytes total)
      uint16_t w = BADGE_W;
      uint16_t h = BADGE_H;
      uint16_t payloadLen = 0;
      size_t headerLen = 0;

      if (len >= 10 && data[0] == 'E' && data[1] == 'B' && data[2] == 'G' && data[3] == '1') {
        w = u16le(data + 4);
        h = u16le(data + 6);
        payloadLen = u16le(data + 8);
        headerLen = 10;

        Serial.print("[ble:fb] Header EBG1 w=");
        Serial.print(w);
        Serial.print(" h=");
        Serial.print(h);
        Serial.print(" len=");
        Serial.println(payloadLen);
        Serial.print("[ble:fb] onWrite len=");
        Serial.println((int)len);
      }
      else if (len >= 4 && data[0] == 'F' && data[1] == 'B') {
        payloadLen = u16le(data + 2);
        headerLen = 4;

        Serial.print("[ble:fb] Header FB len=");
        Serial.println(payloadLen);
      }
      else {
        Serial.println("[ble:fb] No valid header found; ignoring packet.");
        return;
      }

      if (w != BADGE_W || h != BADGE_H) {
        Serial.println("[ble:fb] Unexpected dimensions; ignoring transfer.");
        return;
      }
      if (payloadLen != FB_BYTES) {
        Serial.println("[ble:fb] Unexpected payload length; ignoring transfer.");
        return;
      }

      // Start receiving
      g_fbReceiving = true;
      g_fbExpected = payloadLen;
      g_fbOffset = 0;
			g_fbLastProgress = 0;

      consume(headerLen);
    }


    // Copy remaining bytes into framebuffer
    if (g_fbReceiving && len > 0) {
      size_t toCopy = len;
      if (g_fbOffset + toCopy > g_fbExpected) {
        toCopy = g_fbExpected - g_fbOffset;
      }

      if (toCopy > 0) {
        memcpy(g_fb + g_fbOffset, data, toCopy);
        g_fbOffset += (uint16_t)toCopy;
      }

      // Progress logging (every +512 bytes, even if we skip exact boundaries)
      if (g_fbOffset < g_fbExpected && (uint16_t)(g_fbOffset - g_fbLastProgress) >= 512) {
        g_fbLastProgress = g_fbOffset;
        Serial.print("[ble:fb] Progress ");
        Serial.print(g_fbOffset);
        Serial.print("/");
        Serial.println(g_fbExpected);
      }

      // Completion
      if (g_fbOffset >= g_fbExpected) {
        Serial.print("[ble:fb] Frame complete: ");
        Serial.print(g_fbOffset);
        Serial.print("/");
        Serial.println(g_fbExpected);

        g_haveFramebuffer = true;
        g_updateReady = true;
        g_fbReceiving = false;
      }

    }
  }
};

static NimBLEAdvertising* g_adv = nullptr;

static void startBLE() {
  Serial.println("[ble] Initializing BLE...");

  NimBLEDevice::init(BLE_DEVICE_NAME);
  NimBLEDevice::setPower(ESP_PWR_LVL_P9); // MAX power for visibility

  // ---- Speed tweaks ----
  // Let the phone request up to 247 MTU (244 payload bytes per GATT write).
  // This must be set BEFORE connections are established.
  NimBLEDevice::setMTU(247);

  // Prefer faster connection intervals (units are 1.25ms):
  // 12 = 15ms, 24 = 30ms. Latency 0. Timeout 200 = 2s.
  // NimBLEDevice::setConnectionParams(12, 24, 0, 200);

  // Some NimBLE builds support this; Heltec's may or may not.
  // If it fails to compile, just delete this line.
  // NimBLEDevice::setDataLen(251);

  NimBLEServer* server = NimBLEDevice::createServer();
  NimBLEService* svc = server->createService(SERVICE_UUID);

  NimBLECharacteristic* chrText = svc->createCharacteristic(
    CHAR_TEXT_UUID,
    NIMBLE_PROPERTY::WRITE | NIMBLE_PROPERTY::WRITE_NR
  );
  chrText->setCallbacks(new TextCallbacks());

  NimBLECharacteristic* chrFb = svc->createCharacteristic(
    CHAR_FB_UUID,
    NIMBLE_PROPERTY::WRITE | NIMBLE_PROPERTY::WRITE_NR
  );
  chrFb->setCallbacks(new FramebufferCallbacks());

  svc->start();

  g_adv = NimBLEDevice::getAdvertising();
  g_adv->stop();  // safety

  NimBLEAdvertisementData adv;
  adv.setFlags(0x06); // LE General Discoverable, BR/EDR not supported
  adv.setName(BLE_DEVICE_NAME);
  adv.addServiceUUID(NimBLEUUID(SERVICE_UUID));

  NimBLEAdvertisementData scanResp;
  scanResp.setName(BLE_DEVICE_NAME);

  g_adv->setAdvertisementData(adv);
  g_adv->setScanResponseData(scanResp);
  g_adv->setMinInterval(0x20); // fast advertising
  g_adv->setMaxInterval(0x40);

  bool ok = g_adv->start();
  Serial.print("[ble] Advertising start returned: ");
  Serial.println(ok ? "true" : "false");
}


static void stopBLE() {
  Serial.println("[ble] Stopping BLE...");
  if (g_adv) g_adv->stop();
  NimBLEDevice::deinit(true);
  Serial.println("[ble] BLE stopped.");
}

// -------- Serial input handling --------
// Reads newline-terminated text. When a full line arrives, treat as an update.
static void pollSerialForLine() {
  while (Serial.available() > 0) {
    char c = (char)Serial.read();
    if (c == '\r') continue;

    if (c == '\n') {
      g_serialLine.trim();
      if (g_serialLine.length() > 0) {
        if (g_serialLine.length() > 200) {
          g_serialLine = g_serialLine.substring(0, 200);
        }
        g_latestText = g_serialLine;
        g_haveFramebuffer = false;
        g_updateReady = true;

        Serial.print("[serial] Received line: ");
        Serial.println(g_latestText);
      }
      g_serialLine = "";
      return;
    }

    if (g_serialLine.length() < 300) {
      g_serialLine += c;
    }
  }
}

void setup() {
  Serial.begin(115200);
  delay(300);
  Serial.println();
  Serial.println("[boot] E-Badge starting...");

  pinMode((int)WAKE_BTN, INPUT_PULLUP);

  pinMode(USER_LED_PIN, OUTPUT);
  digitalWrite(USER_LED_PIN, LOW);

  // 180-degree rotation vs your earlier GPIO test sketch
  display.setRotation(2);
  Serial.print("[display] width=");
  Serial.print(display.width());
  Serial.print(" height=");
  Serial.println(display.height());
  
// If we woke via the user button (EXT0), do NOT redraw the e-ink.
// The panel retains the previous image with no power, and we want accidental wakes
// to time out without changing what is displayed.
if (wokeFromButton()) {
  Serial.println("[boot] Wake from button; leaving display unchanged.");
} else {
  Serial.println("[boot] Cold boot; drawing boot logo.");
  drawBootLogo();
}

  // Reset RX state
  g_fbReceiving = false;
  g_fbOffset = 0;
  g_updateReady = false;
  g_haveFramebuffer = false;

  startBLE();

  Serial.println("[boot] Ready. Send framebuffer via BLE or text via Serial/BLE.");
}

void loop() {
  static uint32_t startMs = millis();
  static uint32_t lastActivityMs = millis();   // resets on double-tap
  static uint32_t lastBlinkMs = 0;
  static bool ledOn = false;

  // Button state for debounce + double-tap (active LOW)
  static bool lastBtnRaw = true;
  static bool btnStable = true;
  static uint32_t lastDebounceMs = 0;

  static bool waitingSecondTap = false;
  static uint32_t firstTapMs = 0;

 static uint32_t lastLog = 0;
 if (millis() - lastLog > 2000) {
   lastLog = millis();
   Serial.println("[loop] alive");
 }

  // Blink user LED while awake/connectable: 500ms on/off
  uint32_t now = millis();
  if (now - lastBlinkMs >= 500) {
    lastBlinkMs = now;
    ledOn = !ledOn;
    digitalWrite(USER_LED_PIN, ledOn ? HIGH : LOW);
  }

  pollSerialForLine();

  // -------- Double-tap handler (rotate screens) --------
  bool btnRaw = (digitalRead((int)WAKE_BTN) == HIGH); // HIGH = not pressed, LOW = pressed -> so btnRaw==false when pressed

  if (btnRaw != lastBtnRaw) {
    lastDebounceMs = now;
    lastBtnRaw = btnRaw;
  }

  if ((now - lastDebounceMs) > DEBOUNCE_MS) {
    if (btnStable != btnRaw) {
      btnStable = btnRaw;

      // We trigger on "press" (transition to LOW => btnStable becomes false)
      if (btnStable == false) {
        if (!waitingSecondTap) {
          waitingSecondTap = true;
          firstTapMs = now;
        } else {
          // Second tap
          if (now - firstTapMs <= DOUBLE_TAP_WINDOW_MS) {
            waitingSecondTap = false;

            // Rotate mode: Status -> Live -> Saved -> Boot -> Status...
            switch (g_uiMode) {
              case UI_STATUS: g_uiMode = UI_LIVE;  break;
              case UI_LIVE:   g_uiMode = UI_SAVED; break;
              case UI_SAVED:  g_uiMode = UI_BOOT;  break;
              case UI_BOOT:   g_uiMode = UI_STATUS;break;
              default:        g_uiMode = UI_STATUS;break;
            }

            Serial.print("[ui] Double-tap, mode=");
            Serial.println((int)g_uiMode);

            if (g_uiMode == UI_STATUS) drawStatusScreen();
            else if (g_uiMode == UI_LIVE) {
              // Live means "whatever is currently on the panel".
              // If we woke-from-button, we intentionally didn't redraw anything,
              // so leaving it alone is correct here.
              Serial.println("[ui] Live: leaving display as-is.");
            }
            else if (g_uiMode == UI_SAVED) drawSavedFramebuffer();
            else if (g_uiMode == UI_BOOT) drawBootLogo();

            lastActivityMs = now;
          } else {
            // Too slow, treat this as the new first tap
            firstTapMs = now;
          }
        }
      }
    }
  }

  // If we never got a second tap in time, clear it
  if (waitingSecondTap && (now - firstTapMs > DOUBLE_TAP_WINDOW_MS)) {
    waitingSecondTap = false;
  }

  // If update received, apply it and sleep
    if (g_updateReady) {
    Serial.println("[update] Applying update to display...");
    stopBLE();

    if (g_haveFramebuffer) {
      // Save framebuffer for later rotation (retained across deep sleep)
      memcpy(g_savedFb, g_fb, FB_BYTES);
      g_hasSavedFb = true;
      g_uiMode = UI_LIVE;

      drawFramebufferToDisplay(g_fb, BADGE_W, BADGE_H);
    } else {
      // For text-only updates, we display it but we do NOT save a framebuffer
      // (we could render to a 1bpp buffer later if you want).
      g_uiMode = UI_LIVE;
      drawCenteredText(g_latestText, 2);
    }

    Serial.println("[update] Display update done.");
    goToDeepSleep();
  }

  // Timeout -> sleep
  if (millis() - lastActivityMs >= INTERACT_WINDOW_MS) {
    Serial.println("[timeout] No interaction in 5 minutes.");
    stopBLE();
    goToDeepSleep();
  }

  delay(10);
}
